---
- hosts: all
  remote_user: "{{ setup_user_name }}"
  become: yes
  become_user: root

  vars:

    #request_name: 'somename'  ----> CALL AS: ansible-playbook --extra-vars 'request_name=somename' ....
    cvmfs_quota_limit: 20000
    cvmfs_http_proxy: 'http://squid.grid.uchicago.edu:3128'

  tasks:
    - name: Set hostname
      hostname:
        name: "{{ request_name }}.virtualclusters.org"

    - name: Install EPEL
      yum:
        name: epel-release
        state: latest
    - name: Install OSG repos
      yum:
        name: http://mirror.grid.uchicago.edu/pub/osg/3.4/el7/release/x86_64/osg-release-3.4-2.osg34.el7.noarch.rpm
        state: latest

    - name: Install Perl
      yum:
        name: perl
        state: latest

    - name: Install HTCondor
      yum:
        name: condor
        state: latest

    - name: Configure HTCondor
      template:
        src: templates/condor_config.local.j2
        dest: /etc/condor/condor_config.local
        owner: root
        group: root
        mode: 0644
      notify: restart htcondor

    - meta: flush_handlers
  
    - name: create condor password
      shell: condor_store_cred -c add -p "{{ lookup('password', '/dev/null length=64') }}"
  
    - name: fetch condor password file
      fetch:
        src:  /etc/condor/condor_password
        dest: "{{ condor_password_file }}"
        flat: yes

    - name: Install CVMFS
      yum:
        name: osg-oasis
        state: latest
    - name: Add auto.cvmfs
      lineinfile:
        path: /etc/auto.master
        regexp: '^\/cvmfs'
        line: '/cvmfs /etc/auto.cvmfs'
      notify: restart autofs
    - name: Copy CVMFS config
      template:
        src: templates/cvmfs_default_local.j2
        dest: /etc/cvmfs/default.local
        owner: root
        group: root
        mode: 0644

    - name: Add VC3 users
      user:
        name: "{{ item.key }}"
        comment: "{{ item.key }}"
        state: present
      with_dict: "{{ production_keys }}"

    - name: Add VC3 user keys
      authorized_key:
        user: "{{ item.key }}"
        state: present
        key: "{{ item.value }}"
      with_dict: "{{ production_keys }}"

    - name: Add MOTD template
      template:
        src: templates/motd.j2
        dest: /etc/motd
        owner: root
        group: root
        mode: 0644

  handlers:
  - name: restart htcondor
    service: name=condor state=restarted
  - name: restart autofs
    service: name=autofs state=restarted
